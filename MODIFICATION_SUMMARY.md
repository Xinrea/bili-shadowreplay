# Recorder Update Entries 修改总结

## 问题描述

目前 recorder 的 `update_entries` 遇到错误时会重新获取一次 stream 地址，并使用时间戳作为 `live_id` 创建新的记录和目录。这会导致即使后续下载 ts 文件失败，也会产生空的记录和目录。

## 解决方案

修改逻辑，使得**仅当成功下载 ts 文件后才创建记录和目录**。

## 具体修改

### 1. Douyin Recorder (`src-tauri/src/recorder/douyin.rs`)

#### 修改 `check_status` 函数：
- **移除**：在检测到直播开始时立即创建数据库记录和目录的逻辑
- **保留**：只设置 `stream_url` 和 `danmu_room_id`，为后续下载做准备

#### 修改 `update_entries` 函数：
- **新增**：`is_first_segment` 变量来跟踪是否为第一个片段
- **延迟创建**：只有在第一个 ts 文件成功下载后才：
  - 创建工作目录
  - 创建数据库记录
  - 初始化 `EntryStore` 和 `DanmuStorage`
  - 启动弹幕任务

### 2. Bilibili Recorder (`src-tauri/src/recorder/bilibili.rs`)

#### 修改 `update_entries` 函数：
- **FMP4 流**：延迟到 header 文件成功下载后才创建记录和存储
- **非 FMP4 流**：延迟到第一个 ts 文件成功下载后才创建记录和存储
- **新增**：`is_first_record` 变量来跟踪是否需要创建初始记录

## 主要改进

1. **避免空记录**：只有在实际下载内容后才创建数据库记录
2. **避免空目录**：只有在需要存储文件时才创建工作目录
3. **资源优化**：避免创建不必要的弹幕任务和存储对象
4. **错误处理改进**：如果下载失败，不会留下空的记录和目录

## 行为变化

### 之前的行为：
1. 检测到直播开始 → 立即创建记录和目录
2. 尝试下载 ts 文件
3. 如果下载失败 → 空的记录和目录仍然存在

### 修改后的行为：
1. 检测到直播开始 → 只准备 stream URL
2. 尝试下载 ts 文件
3. 下载成功 → 创建记录和目录
4. 下载失败 → 不创建任何记录和目录

## 测试建议

1. **正常流程测试**：确保直播开始时能正常创建记录和下载内容
2. **网络错误测试**：模拟网络错误，确保不会创建空记录
3. **Stream URL 过期测试**：确保 stream URL 过期时不会创建空记录
4. **弹幕功能测试**：确保弹幕任务在正确的时机启动

## 注意事项

- 修改后，第一个片段的下载时间可能略有增加（需要同时创建目录和记录）
- 确保错误处理逻辑正确，避免在下载失败时泄露资源
- 弹幕任务现在会在实际开始录制时启动，而不是检测到直播时启动