# Recorder Update Entries 修改总结

## 问题描述

目前 recorder 的 `update_entries` 遇到错误时会重新获取一次 stream 地址，并使用时间戳作为 `live_id` 创建新的记录和目录。这会导致即使后续下载 ts 文件失败，也会产生空的记录和目录。

## 解决方案

修改逻辑，使得**仅当成功下载 ts 文件后才创建记录和初始化存储**，同时**在下载失败时清理空目录**。

## 具体修改

### 1. Douyin Recorder (`src-tauri/src/recorder/douyin.rs`)

#### 修改 `check_status` 函数：
- **移除**：在检测到直播开始时立即创建数据库记录和目录的逻辑
- **保留**：只设置 `stream_url` 和 `danmu_room_id`，为后续下载做准备

#### 修改 `update_entries` 函数：
- **新增**：`is_first_segment` 变量来跟踪是否为第一个片段
- **新增**：`work_dir_created` 变量来跟踪目录是否已创建
- **目录管理**：
  - 在第一次下载尝试前创建工作目录
  - 如果下载失败，删除空的工作目录
- **延迟创建**：只有在第一个 ts 文件成功下载后才：
  - 创建数据库记录
  - 初始化 `EntryStore` 和 `DanmuStorage`
  - 启动弹幕任务

### 2. Bilibili Recorder (`src-tauri/src/recorder/bilibili.rs`)

#### 修改 `update_entries` 函数：
- **FMP4 流**：
  - 在 header 下载前创建目录
  - 如果 header 下载失败，删除空目录
  - 只有在 header 成功下载后才创建记录和存储
- **非 FMP4 流**：
  - 在第一个 ts 下载前创建目录
  - 如果下载失败，删除空目录
  - 只有在第一个 ts 成功下载后才创建记录和存储
- **新增**：`is_first_record` 和 `work_dir_created_for_non_fmp4` 变量来跟踪状态

## 主要改进

1. **避免空记录**：只有在实际下载内容后才创建数据库记录
2. **避免空目录**：下载失败时会自动清理创建的空目录
3. **资源优化**：避免创建不必要的弹幕任务和存储对象
4. **完善的错误处理**：所有下载失败的情况都会清理创建的目录
5. **重试机制优化**：在重试过程中不会重复创建目录

## 目录清理策略

### 清理时机：
1. **下载返回 0 字节**：立即清理空目录
2. **网络错误（如 HTTP 400）**：清理空目录并返回错误
3. **重试次数耗尽**：清理空目录
4. **其他下载错误**：清理空目录并返回错误

### 清理逻辑：
- 使用 `tokio::fs::remove_dir_all()` 删除整个工作目录
- 清理失败时记录警告日志，但不影响主流程
- 只有在确实创建了目录的情况下才尝试清理

## 行为变化

### 之前的行为：
1. 检测到直播开始 → 立即创建记录和目录
2. 尝试下载 ts 文件
3. 如果下载失败 → 空的记录和目录仍然存在

### 修改后的行为：
1. 检测到直播开始 → 只准备 stream URL
2. 准备下载时 → 创建工作目录
3. 尝试下载 ts 文件
4. 下载成功 → 创建记录和初始化存储
5. 下载失败 → 删除空目录，不创建任何记录

## 测试建议

1. **正常流程测试**：确保直播开始时能正常创建记录和下载内容
2. **网络错误测试**：模拟网络错误，确保空目录被正确清理
3. **Stream URL 过期测试**：确保过期时清理目录且不创建记录
4. **重试机制测试**：确保重试过程中不重复创建目录
5. **目录权限测试**：测试目录创建和删除的权限问题
6. **弹幕功能测试**：确保弹幕任务在正确的时机启动
7. **并发测试**：确保多个录制任务不会相互干扰

## 注意事项

- 修改后，第一个片段的下载时间可能略有增加（需要同时创建目录和记录）
- 目录清理操作是异步的，失败时只记录警告不影响主流程
- 弹幕任务现在会在实际开始录制时启动，而不是检测到直播时启动
- 需要确保文件系统有足够的权限进行目录创建和删除操作